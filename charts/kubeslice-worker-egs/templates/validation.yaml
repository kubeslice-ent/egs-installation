{{/*
This template validates the global configuration and fails fast if there are issues.
It's included at the top of key deployment templates to ensure validation happens early.
*/}}
{{- include "kubeslice.validateImageConfig" . -}}

{{/*
Additional validation for production readiness
*/}}
{{- if not .Values.cluster.name -}}
  {{- fail "cluster.name is required for KubeSlice worker deployment" -}}
{{- end -}}

{{- if not .Values.cluster.endpoint -}}
  {{- fail "cluster.endpoint is required for KubeSlice worker deployment" -}}
{{- end -}}

{{/*
Validate that global imagePullSecrets configuration is consistent
*/}}
{{- if and .Values.global.imagePullSecrets.create .Values.global.imagePullSecrets.existingSecret -}}
  {{- fail "global.imagePullSecrets.create and global.imagePullSecrets.existingSecret cannot both be set" -}}
{{- end -}}

{{/*
Environment-specific validation
*/}}
{{- if .Values.global.environment -}}
  {{- $validEnvs := list "development" "staging" "production" -}}
  {{- if not (has .Values.global.environment $validEnvs) -}}
    {{- fail (printf "global.environment must be one of: %s" (join ", " $validEnvs)) -}}
  {{- end -}}
{{- end -}}

---
# This ConfigMap serves as a validation checkpoint and provides runtime configuration info
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kubeslice-operator.fullname" . }}-global-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kubeslice-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: global-config
  annotations:
    {{- include "kubeslice.imagePullAnnotations" . | nindent 4 }}
    kubeslice.io/config-validation: "passed"
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-15"
data:
  global-image-registry: {{ .Values.global.imageRegistry | quote }}
  global-image-pull-policy: {{ .Values.global.imagePullPolicy | quote }}
  global-image-pull-secret: {{ include "kubeslice.imagePullSecrets" . | quote }}
  environment: {{ .Values.global.environment | default "production" | quote }}
  cluster-name: {{ .Values.cluster.name | quote }}
  cluster-endpoint: {{ .Values.cluster.endpoint | quote }}
  validation-timestamp: {{ now | date "2006-01-02T15:04:05Z" | quote }}
